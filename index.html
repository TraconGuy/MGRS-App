<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MGRS Tool</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MGRS Tool">

  <style>
    :root {
      --bg: #000000;
      --gray: #808080;
      --input-bg: #333333;
      --border: #555555;
      --lime: #aaff00;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 600px;
      margin: 1.5rem auto;
      padding: 0 1rem 2rem;
      line-height: 1.4;
      background: var(--bg);
      color: var(--gray);
    }

    .section {
      margin-bottom: 1.2rem;
    }

    .label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--gray);
      margin-bottom: 0.2rem;
    }

    .coord-input {
      width: 100%;
      padding: 0.6rem 0.7rem;
      box-sizing: border-box;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 1.6rem; /* larger font for coords */
      color: var(--lime);
      outline: none;
    }

    .coord-input::placeholder {
      color: #666666;
    }

    .decl-label {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 0.2rem;
    }

    .decl-input {
      width: 100%;
      padding: 0.45rem 0.6rem;
      box-sizing: border-box;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 1.1rem;
      color: var(--lime);
      outline: none;
    }

    .decl-input::placeholder {
      color: #666666;
    }

    button {
      margin-top: 0.8rem;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--gray);
      font-size: 0.95rem;
    }

    button:active {
      transform: scale(0.98);
    }

    .results {
      margin-top: 1rem;
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--lime);
      white-space: pre-line;
      text-align: center;
      font-size: 1.6rem;
      min-height: 3.5rem;
    }

    .error {
      color: var(--gray);
      margin-top: 0.4rem;
      font-size: 0.85rem;
      min-height: 1rem;
    }
  </style>
</head>
<body>
  <div class="section">
    <div class="label">Point A</div>
    <input id="mgrsA" class="coord-input" type="text" autocomplete="off"
           placeholder="MGRS for Point A">
  </div>

  <div class="section">
    <div class="label">Point B</div>
    <input id="mgrsB" class="coord-input" type="text" autocomplete="off"
           placeholder="MGRS for Point B">
  </div>

  <div class="section">
    <div class="decl-label">
      Declination (°) &nbsp; <span style="font-size:0.75rem;">(+ East, − West, optional)</span>
    </div>
    <input id="declination" class="decl-input" type="number" step="0.1"
           placeholder="e.g. 2.5 or -3.0">
  </div>

  <button onclick="compute()">Compute</button>

  <div id="error" class="error"></div>
  <div id="results" class="results"></div>

  <!-- Local MGRS library (offline) -->
  <script src="mgrs.min.js"></script>

  <script>
    // Register service worker for offline support (if present)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => {
          console.error('SW registration failed:', err);
        });
      });
    }

    function toRad(deg) {
      return deg * Math.PI / 180;
    }

    function normalizeAngle(deg) {
      deg = deg % 360;
      if (deg < 0) deg += 360;
      return deg;
    }

    function formatAz(deg) {
      const n = Math.round(normalizeAngle(deg));
      const padded = String(n).padStart(3, '0');
      return padded + '°';
    }

    function compute() {
      const mgrsA = document.getElementById('mgrsA').value.trim();
      const mgrsB = document.getElementById('mgrsB').value.trim();
      const declStr = document.getElementById('declination').value.trim();
      const errorEl = document.getElementById('error');
      const resultsEl = document.getElementById('results');

      errorEl.textContent = '';
      resultsEl.textContent = '';

      if (!mgrsA || !mgrsB) {
        errorEl.textContent = 'Enter coordinates for both points.';
        return;
      }

      let decl = 0;
      if (declStr !== '') {
        const parsed = Number(declStr);
        if (Number.isNaN(parsed)) {
          errorEl.textContent = 'Declination must be a number.';
          return;
        }
        decl = parsed; // +East, -West
      }

      try {
        // mgrs.toPoint returns [lon, lat] in degrees
        const [lonA, latA] = mgrs.toPoint(mgrsA);
        const [lonB, latB] = mgrs.toPoint(mgrsB);

        const R = 6371000; // Earth radius in meters (approx)

        const latA_rad = toRad(latA);
        const latB_rad = toRad(latB);
        const lonA_rad = toRad(lonA);
        const lonB_rad = toRad(lonB);

        const dLat = latB_rad - latA_rad;
        const dLon = lonB_rad - lonA_rad;
        const latAvg = (latA_rad + latB_rad) / 2;

        // Local EN approximation (good for land-nav distances)
        const dNorth = dLat * R;
        const dEast  = dLon * Math.cos(latAvg) * R;

        const distance = Math.hypot(dEast, dNorth); // meters

        // Grid azimuth (from A to B, 0–360, 0 = north)
        const azRad = Math.atan2(dEast, dNorth);
        const gridAz = azRad * 180 / Math.PI;

        const magAz = normalizeAngle(gridAz + decl);

        const gridAzStr = formatAz(gridAz);
        const magAzStr  = formatAz(magAz);
        const distStr   = Math.round(distance) + ' m';

        // Only results: grid az, distance, magnetic az — no labels
        resultsEl.textContent = gridAzStr + '\n' + distStr + '\n' + magAzStr;
      } catch (e) {
        console.error(e);
        errorEl.textContent = 'Error parsing MGRS. Check format and try again.';
      }
    }
  </script>
</body>
</html>
